<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fornecedores - Gerenciamento</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6b5b95 0%, #9b8ab8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav a {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .nav a:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav a.active {
            background: white;
            color: #6b5b95;
            font-weight: bold;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #6b5b95;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6b5b95 0%, #9b8ab8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 91, 149, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        }

        /* Tabela de fornecedores */
        .tabela-fornecedores {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .tabela-fornecedores th,
        .tabela-fornecedores td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .tabela-fornecedores th {
            background: #f8f9fa;
            color: #6b5b95;
            font-weight: 600;
        }

        .tabela-fornecedores tr:hover {
            background: #f5f5f5;
        }

        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
        }

        .tag-blocos { background: #e3f2fd; color: #1565c0; }
        .tag-eps { background: #e8f5e9; color: #2e7d32; }
        .tag-tijolos { background: #fff3e0; color: #e65100; }
        .tag-cimento { background: #fce4ec; color: #c2185b; }

        /* Formulario */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6b5b95;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #6b5b95;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        /* Historico de precos */
        .preco-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #6b5b95;
        }

        .preco-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .preco-data {
            font-size: 0.9rem;
            color: #666;
        }

        .preco-produtos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .preco-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .preco-valor {
            font-size: 1.2rem;
            font-weight: bold;
            color: #6b5b95;
        }

        .preco-nome {
            font-size: 0.85rem;
            color: #666;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .tab.active {
            background: #6b5b95;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Link WhatsApp */
        .whatsapp-link {
            color: #25D366;
            text-decoration: none;
            font-weight: 600;
        }

        .whatsapp-link:hover {
            text-decoration: underline;
        }

        footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <a href="index.html">Blocok</a>
            <a href="eps.html">EPS Isolamento</a>
            <a href="fornecedores.html" class="active">Fornecedores</a>
        </nav>

        <header>
            <h1>Gerenciamento de Fornecedores</h1>
            <p>Cadastro de fornecedores e historico de precos</p>
        </header>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('fornecedores')">Fornecedores</button>
                <button class="tab" onclick="showTab('precos')">Historico de Precos</button>
                <button class="tab" onclick="showTab('novo-preco')">Atualizar Precos</button>
            </div>

            <!-- Tab Fornecedores -->
            <div id="tab-fornecedores" class="tab-content active">
                <h2>
                    Fornecedores Cadastrados
                    <button class="btn btn-sm" onclick="abrirModalFornecedor()">+ Novo Fornecedor</button>
                </h2>
                <table class="tabela-fornecedores">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Contato</th>
                            <th>Telefone</th>
                            <th>Categorias</th>
                            <th>Acoes</th>
                        </tr>
                    </thead>
                    <tbody id="lista-fornecedores">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Tab Historico de Precos -->
            <div id="tab-precos" class="tab-content">
                <h2>Historico de Precos</h2>
                <div class="form-group" style="max-width: 300px;">
                    <select id="filtro-categoria" onchange="filtrarPrecos()">
                        <option value="">Todas as categorias</option>
                        <option value="blocos">Blocos</option>
                        <option value="eps">EPS</option>
                    </select>
                </div>
                <div id="lista-precos">
                    <!-- Preenchido via JS -->
                </div>
            </div>

            <!-- Tab Novo Preco -->
            <div id="tab-novo-preco" class="tab-content">
                <h2>Registrar Atualizacao de Precos</h2>
                <form id="form-precos" onsubmit="salvarPrecos(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Fornecedor</label>
                            <select id="preco-fornecedor" required>
                                <!-- Preenchido via JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="preco-categoria" required onchange="carregarProdutosCategoria()">
                                <option value="">Selecione...</option>
                                <option value="blocos">Blocos</option>
                                <option value="eps">EPS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="preco-data" required>
                        </div>
                    </div>

                    <div id="campos-produtos" style="display: none;">
                        <h3 style="margin: 20px 0 15px; color: #6b5b95;">Precos dos Produtos</h3>
                        <div id="lista-produtos-preco" class="form-grid">
                            <!-- Campos dinamicos -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observacao</label>
                        <input type="text" id="preco-obs" placeholder="Ex: Orcamento via WhatsApp">
                    </div>

                    <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                        Salvar Precos
                    </button>
                </form>
            </div>
        </div>

        <footer>
            <p>Sistema de Gerenciamento de Fornecedores</p>
        </footer>
    </div>

    <!-- Modal Fornecedor -->
    <div id="modal-fornecedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Novo Fornecedor</h3>
                <button class="close-btn" onclick="fecharModal()">&times;</button>
            </div>
            <form id="form-fornecedor" onsubmit="salvarFornecedor(event)">
                <input type="hidden" id="fornecedor-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome *</label>
                        <input type="text" id="fornecedor-nome" required>
                    </div>
                    <div class="form-group">
                        <label>Contato</label>
                        <input type="text" id="fornecedor-contato" placeholder="Nome do vendedor">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" id="fornecedor-telefone" placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group">
                        <label>WhatsApp</label>
                        <input type="text" id="fornecedor-whatsapp" placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="fornecedor-email">
                    </div>
                    <div class="form-group">
                        <label>Site</label>
                        <input type="url" id="fornecedor-site" placeholder="https://...">
                    </div>
                </div>
                <div class="form-group">
                    <label>Endereco</label>
                    <input type="text" id="fornecedor-endereco">
                </div>
                <div class="form-group">
                    <label>Categorias</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" value="blocos" class="cat-check"> Blocos</label>
                        <label><input type="checkbox" value="eps" class="cat-check"> EPS</label>
                        <label><input type="checkbox" value="tijolos" class="cat-check"> Tijolos</label>
                        <label><input type="checkbox" value="cimento" class="cat-check"> Cimento</label>
                    </div>
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 15px;">Salvar</button>
            </form>
        </div>
    </div>

    <script>
        // Dados carregados
        let fornecedores = [];
        let historico = [];

        // Produtos por categoria (para formulario de precos)
        const produtosPorCategoria = {
            blocos: [
                { produto_id: 1, nome: "Blocok 10" },
                { produto_id: 2, nome: "Blocok 13" },
                { produto_id: 3, nome: "Blocok 15" },
                { produto_id: 4, nome: "Blocok 20" }
            ],
            eps: [
                { produto_id: 1, nome: "EPS 30mm" },
                { produto_id: 2, nome: "EPS 40mm" },
                { produto_id: 3, nome: "EPS 100mm" }
            ]
        };

        // Inicializacao
        document.addEventListener('DOMContentLoaded', () => {
            carregarFornecedores();
            carregarHistorico();
            document.getElementById('preco-data').valueAsDate = new Date();
        });

        // ============ TABS ============

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ============ FORNECEDORES ============

        async function carregarFornecedores() {
            try {
                const resp = await fetch('/api/fornecedores');
                fornecedores = await resp.json();
                renderizarFornecedores();
                atualizarSelectFornecedores();
            } catch (e) {
                // Modo offline - usa dados estaticos
                fornecedores = [
                    { id: 1, nome: "Blocok Sao Paulo", contato: "Comercial", telefone: "(11) 93068-9990", whatsapp: "(11) 93068-9990", categorias: ["blocos"] },
                    { id: 2, nome: "Isoportal", contato: "Victor", telefone: "(11) 97572-0094", whatsapp: "(11) 97572-0094", categorias: ["eps"] }
                ];
                renderizarFornecedores();
                atualizarSelectFornecedores();
            }
        }

        function renderizarFornecedores() {
            const tbody = document.getElementById('lista-fornecedores');
            tbody.innerHTML = fornecedores.map(f => `
                <tr>
                    <td>
                        <strong>${f.nome}</strong>
                        ${f.site ? `<br><a href="${f.site}" target="_blank" style="font-size: 0.85rem; color: #6b5b95;">${f.site}</a>` : ''}
                    </td>
                    <td>${f.contato || '-'}</td>
                    <td>
                        ${f.whatsapp ? `<a href="https://wa.me/55${f.whatsapp.replace(/\D/g,'')}" class="whatsapp-link" target="_blank">${f.telefone || f.whatsapp}</a>` : (f.telefone || '-')}
                    </td>
                    <td>${(f.categorias || []).map(c => `<span class="tag tag-${c}">${c}</span>`).join('')}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editarFornecedor(${f.id})">Editar</button>
                    </td>
                </tr>
            `).join('');
        }

        function atualizarSelectFornecedores() {
            const select = document.getElementById('preco-fornecedor');
            select.innerHTML = '<option value="">Selecione...</option>' +
                fornecedores.map(f => `<option value="${f.id}">${f.nome}</option>`).join('');
        }

        function abrirModalFornecedor() {
            document.getElementById('modal-titulo').textContent = 'Novo Fornecedor';
            document.getElementById('form-fornecedor').reset();
            document.getElementById('fornecedor-id').value = '';
            document.getElementById('modal-fornecedor').classList.add('show');
        }

        function fecharModal() {
            document.getElementById('modal-fornecedor').classList.remove('show');
        }

        function editarFornecedor(id) {
            const f = fornecedores.find(x => x.id === id);
            if (!f) return;

            document.getElementById('modal-titulo').textContent = 'Editar Fornecedor';
            document.getElementById('fornecedor-id').value = f.id;
            document.getElementById('fornecedor-nome').value = f.nome || '';
            document.getElementById('fornecedor-contato').value = f.contato || '';
            document.getElementById('fornecedor-telefone').value = f.telefone || '';
            document.getElementById('fornecedor-whatsapp').value = f.whatsapp || '';
            document.getElementById('fornecedor-email').value = f.email || '';
            document.getElementById('fornecedor-site').value = f.site || '';
            document.getElementById('fornecedor-endereco').value = f.endereco || '';

            // Checkboxes de categorias
            document.querySelectorAll('.cat-check').forEach(cb => {
                cb.checked = (f.categorias || []).includes(cb.value);
            });

            document.getElementById('modal-fornecedor').classList.add('show');
        }

        async function salvarFornecedor(event) {
            event.preventDefault();

            const categorias = Array.from(document.querySelectorAll('.cat-check:checked')).map(cb => cb.value);

            const dados = {
                nome: document.getElementById('fornecedor-nome').value,
                contato: document.getElementById('fornecedor-contato').value || null,
                telefone: document.getElementById('fornecedor-telefone').value || null,
                whatsapp: document.getElementById('fornecedor-whatsapp').value || null,
                email: document.getElementById('fornecedor-email').value || null,
                site: document.getElementById('fornecedor-site').value || null,
                endereco: document.getElementById('fornecedor-endereco').value || null,
                categorias: categorias
            };

            const id = document.getElementById('fornecedor-id').value;

            try {
                if (id) {
                    await fetch(`/api/fornecedores/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    await fetch('/api/fornecedores', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                fecharModal();
                carregarFornecedores();
            } catch (e) {
                alert('Erro ao salvar. API offline?');
            }
        }

        // ============ HISTORICO DE PRECOS ============

        async function carregarHistorico() {
            try {
                const resp = await fetch('/api/precos');
                historico = await resp.json();
                renderizarHistorico();
            } catch (e) {
                // Modo offline
                historico = [
                    {
                        id: 1, data: "2025-01-10", fornecedor_id: 1, categoria: "blocos",
                        produtos: [
                            { produto_id: 1, nome: "Blocok 10", preco: 97.75 },
                            { produto_id: 2, nome: "Blocok 13", preco: 105.45 },
                            { produto_id: 3, nome: "Blocok 15", preco: 112.95 },
                            { produto_id: 4, nome: "Blocok 20", preco: 130.61 }
                        ],
                        observacao: "Catalogo 2025"
                    },
                    {
                        id: 2, data: "2025-01-10", fornecedor_id: 2, categoria: "eps",
                        produtos: [
                            { produto_id: 1, nome: "EPS 30mm", preco: 7.95 },
                            { produto_id: 2, nome: "EPS 40mm", preco: 10.60 },
                            { produto_id: 3, nome: "EPS 100mm", preco: 26.50 }
                        ],
                        observacao: "Orcamento WhatsApp - Victor"
                    }
                ];
                renderizarHistorico();
            }
        }

        function renderizarHistorico(filtro = '') {
            const container = document.getElementById('lista-precos');
            let dados = historico;

            if (filtro) {
                dados = dados.filter(h => h.categoria === filtro);
            }

            if (dados.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">Nenhum registro encontrado.</p>';
                return;
            }

            container.innerHTML = dados.map(h => {
                const fornecedor = fornecedores.find(f => f.id === h.fornecedor_id);
                return `
                    <div class="preco-card">
                        <div class="preco-header">
                            <div>
                                <strong>${fornecedor ? fornecedor.nome : 'Fornecedor #' + h.fornecedor_id}</strong>
                                <span class="tag tag-${h.categoria}">${h.categoria}</span>
                            </div>
                            <span class="preco-data">${formatarData(h.data)}</span>
                        </div>
                        <div class="preco-produtos">
                            ${h.produtos.map(p => `
                                <div class="preco-item">
                                    <div class="preco-valor">R$ ${p.preco.toFixed(2)}</div>
                                    <div class="preco-nome">${p.nome}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${h.observacao ? `<p style="margin-top: 10px; font-size: 0.9rem; color: #666;"><em>${h.observacao}</em></p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function filtrarPrecos() {
            const filtro = document.getElementById('filtro-categoria').value;
            renderizarHistorico(filtro);
        }

        function formatarData(dataStr) {
            const [ano, mes, dia] = dataStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // ============ NOVO PRECO ============

        function carregarProdutosCategoria() {
            const categoria = document.getElementById('preco-categoria').value;
            const container = document.getElementById('lista-produtos-preco');
            const camposDiv = document.getElementById('campos-produtos');

            if (!categoria) {
                camposDiv.style.display = 'none';
                return;
            }

            const produtos = produtosPorCategoria[categoria] || [];
            container.innerHTML = produtos.map(p => `
                <div class="form-group">
                    <label>${p.nome}</label>
                    <input type="number" step="0.01" min="0" id="preco-${p.produto_id}"
                           placeholder="R$ 0,00" data-produto-id="${p.produto_id}" data-nome="${p.nome}">
                </div>
            `).join('');

            camposDiv.style.display = 'block';
        }

        async function salvarPrecos(event) {
            event.preventDefault();

            const fornecedor_id = parseInt(document.getElementById('preco-fornecedor').value);
            const categoria = document.getElementById('preco-categoria').value;
            const data = document.getElementById('preco-data').value;
            const observacao = document.getElementById('preco-obs').value;

            if (!fornecedor_id || !categoria || !data) {
                alert('Preencha todos os campos obrigatorios');
                return;
            }

            // Coleta os precos
            const produtos = [];
            document.querySelectorAll('#lista-produtos-preco input').forEach(input => {
                const valor = parseFloat(input.value);
                if (valor > 0) {
                    produtos.push({
                        produto_id: parseInt(input.dataset.produtoId),
                        nome: input.dataset.nome,
                        preco: valor
                    });
                }
            });

            if (produtos.length === 0) {
                alert('Informe pelo menos um preco');
                return;
            }

            const registro = {
                fornecedor_id,
                categoria,
                produtos,
                data,
                observacao: observacao || null
            };

            try {
                await fetch('/api/precos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(registro)
                });

                alert('Precos salvos com sucesso!');
                document.getElementById('form-precos').reset();
                document.getElementById('campos-produtos').style.display = 'none';
                document.getElementById('preco-data').valueAsDate = new Date();
                carregarHistorico();
                showTab('precos');
            } catch (e) {
                alert('Erro ao salvar. API offline?');
            }
        }
    </script>
</body>
</html>
